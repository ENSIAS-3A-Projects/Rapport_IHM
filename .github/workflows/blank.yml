name: Build LaTeX and Commit PDF

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.tex'
      - '**.bib'
      - '**.cls'
      - 'Chapters/**'
      - 'imgs/**'
      - 'logos/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_latex:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ”¨ Compile LaTeX (3 passes for TOC)
        run: |
          echo "ğŸ”„ Compilation Pass 1/3..."
          pdflatex -shell-escape -interaction=nonstopmode -file-line-error main.tex || true
          
          echo "ğŸ”„ Compilation Pass 2/3 (TOC generation)..."
          pdflatex -shell-escape -interaction=nonstopmode -file-line-error main.tex || true
          
          echo "ğŸ”„ Compilation Pass 3/3 (Finalization)..."
          pdflatex -shell-escape -interaction=nonstopmode -file-line-error main.tex
          
          echo "âœ… Compilation terminÃ©e"
      
      - name: âœ… Verify PDF generation
        id: check_pdf
        run: |
          if [ -f "main.pdf" ]; then
            echo "pdf_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… PDF gÃ©nÃ©rÃ©: $(du -h main.pdf | cut -f1)"
            
            # VÃ©rifier la TOC
            if grep -q "tableofcontents" main.log; then
              echo "âœ… Table des matiÃ¨res dÃ©tectÃ©e dans le log"
            fi
          else
            echo "pdf_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Erreur: main.pdf non gÃ©nÃ©rÃ©"
            exit 1
          fi
      
      - name: ğŸ“ Rename PDF
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        run: |
          cp main.pdf "IHM.pdf"
          echo "ğŸ“„ PDF final: IHM.pdf"
      
      - name: ğŸ§¹ Clean auxiliary files
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        run: |
          rm -f *.aux *.log *.out *.toc *.lof *.lot *.fls *.fdb_latexmk
          rm -f *.synctex.gz *.bbl *.blg *.bcf *.run.xml
          rm -rf _minted-*
          find Chapters -name "*.aux" -delete 2>/dev/null || true
          rm -f main.pdf
      
      - name: ğŸ“¤ Commit PDF
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -f "IHM.pdf"
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto-update PDF - $(date +'%Y-%m-%d %H:%M') [skip ci]"
          else
            echo "â„¹ï¸ Aucun changement dans le PDF"
          fi
      
      - name: ğŸš€ Push changes
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: ğŸ“Š Upload artifact
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: IHM-PDF
          path: IHM.pdf
          retention-days: 30