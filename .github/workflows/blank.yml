name: Build LaTeX and Commit PDF

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.tex'
      - '**.bib'
      - '**.cls'
      - 'Chapters/**'
      - 'imgs/**'
      - 'logos/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_latex:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ”¨ Compile LaTeX document (with latexmk for multiple passes)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          latexmk_shell_escape: true
          # latexmk fait automatiquement plusieurs passes pour la TOC
          args: -pdf -interaction=nonstopmode -file-line-error
        continue-on-error: true
        id: latex_build
      
      - name: âœ… Verify PDF generation
        id: check_pdf
        run: |
          if [ -f "main.pdf" ]; then
            echo "pdf_exists=true" >> $GITHUB_OUTPUT
            PDF_SIZE=$(du -h main.pdf | cut -f1)
            echo "âœ… PDF gÃ©nÃ©rÃ© avec succÃ¨s: $PDF_SIZE"
            
            # VÃ©rifier le nombre de pages
            if command -v pdfinfo &> /dev/null; then
              PAGES=$(pdfinfo main.pdf 2>/dev/null | grep "Pages:" | awk '{print $2}')
              echo "ğŸ“„ Nombre de pages: $PAGES"
            fi
          else
            echo "pdf_exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Erreur: main.pdf non gÃ©nÃ©rÃ©"
            
            # Afficher les erreurs du log si disponible
            if [ -f "main.log" ]; then
              echo "ğŸ” DerniÃ¨res lignes du log:"
              tail -n 30 main.log
            fi
            exit 1
          fi
      
      - name: ğŸ“ Rename PDF
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        run: |
          cp main.pdf "IHM.pdf"
          echo "ğŸ“„ Fichier final: IHM.pdf ($(du -h IHM.pdf | cut -f1))"
      
      - name: ğŸ§¹ Clean auxiliary files
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        run: |
          # Supprimer les fichiers temporaires APRÃˆS la compilation
          rm -f *.aux *.log *.out *.toc *.lof *.lot *.fls *.fdb_latexmk
          rm -f *.synctex.gz *.bbl *.blg *.bcf *.run.xml *.nav *.snm *.vrb
          rm -rf _minted-* __pycache__
          find Chapters -name "*.aux" -delete 2>/dev/null || true
          rm -f main.pdf
          
          echo "ğŸ—‘ï¸ Fichiers temporaires supprimÃ©s"
      
      - name: ğŸ“¤ Commit PDF to repository
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Ajouter le PDF
          git add -f "IHM.pdf"
          
          # VÃ©rifier s'il y a des changements
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Aucun changement dans le PDF"
          else
            BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
            git commit -m "ğŸ¤– Auto-update PDF - $BUILD_DATE [skip ci]"
            echo "âœ… PDF commitÃ© avec succÃ¨s"
          fi
      
      - name: ğŸš€ Push changes
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: ğŸ“Š Upload PDF as artifact
        if: steps.check_pdf.outputs.pdf_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: IHM-PDF-${{ github.run_number }}
          path: IHM.pdf
          retention-days: 30